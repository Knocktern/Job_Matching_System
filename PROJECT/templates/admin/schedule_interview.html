{% extends "base.html" %}

{% block title %}Schedule Interview - JobMatch Pro{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-calendar-plus me-2"></i>Schedule Interview - 24/7 Available</h4>
                </div>
                <div class="card-body">
                    <!-- Application Info -->
                    <div class="alert alert-info mb-4">
                        <h6>Application Details:</h6>
                        <p class="mb-1"><strong>Position:</strong> {{ application.job.title }}</p>
                        <p class="mb-1"><strong>Company:</strong> {{ application.job.company.company_name }}</p>
                        <p class="mb-0"><strong>Candidate:</strong> {{ application.candidate.user.first_name }} {{ application.candidate.user.last_name }}</p>
                    </div>

                    <!-- Employer Recommendations Section -->
                    {% if recommended_interviewers %}
                    <div class="alert alert-warning mb-4">
                        <h6><i class="fas fa-star text-warning me-2"></i>Employer Recommendations</h6>
                        <p class="mb-2">The employer has recommended the following interviewers for this position:</p>
                        {% for rec in recommended_interviewers %}
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-2">
                            <div>
                                <strong>{{ rec.interviewer.first_name }} {{ rec.interviewer.last_name }}</strong>
                                <span class="badge bg-primary ms-2">Recommended</span>
                                <br>
                                <small class="text-muted">{{ rec.interviewer.email }}</small>
                                <br>
                                <small class="text-muted">Recommended by: {{ rec.recommender.first_name }} {{ rec.recommender.last_name }}</small>
                                {% if rec.recommendation_notes %}
                                <br><small class="text-info"><i class="fas fa-comment me-1"></i>{{ rec.recommendation_notes }}</small>
                                {% endif %}
                            </div>
                            <button type="button" 
                                    class="btn btn-sm btn-success" 
                                    onclick="selectRecommendedInterviewer({{ rec.interviewer.id }})">
                                <i class="fas fa-check me-1"></i>Select
                            </button>
                        </div>
                        {% endfor %}
                        <div class="mt-2">
                            <button type="button" 
                                    class="btn btn-sm btn-outline-success" 
                                    onclick="selectAllRecommended()">
                                <i class="fas fa-check-double me-1"></i>Select All Recommended
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <form method="POST">
                        <!-- Date and Time Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="scheduled_time" class="form-label">
                                    <i class="fas fa-clock me-1"></i>Interview Date & Time
                                    <small class="text-success">(24/7 Available)</small>
                                </label>
                                <input type="datetime-local" 
                                       id="scheduled_time" 
                                       name="scheduled_time" 
                                       class="form-control" 
                                       required>
                                <div class="form-text">
                                    <i class="fas fa-info-circle text-success"></i>
                                    You can schedule interviews at any time, any day of the week.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="duration_minutes" class="form-label">
                                    <i class="fas fa-hourglass-half me-1"></i>Duration (Minutes)
                                </label>
                                <select id="duration_minutes" name="duration_minutes" class="form-select">
                                    <option value="30">30 minutes</option>
                                    <option value="45">45 minutes</option>
                                    <option value="60" selected>1 hour</option>
                                    <option value="90">1.5 hours</option>
                                    <option value="120">2 hours</option>
                                    <option value="180">3 hours</option>
                                </select>
                            </div>
                        </div>

                        <!-- Interviewer Selection -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-users me-1"></i>Select Interviewers
                            </label>
                            <div class="row" id="interviewersList">
                                {% for interviewer in interviewers %}
                                <div class="col-md-6 mb-2">
                                    <div class="form-check interviewer-checkbox" 
                                         data-interviewer-id="{{ interviewer.id }}"
                                         {% if recommended_interviewers %}
                                             {% for rec in recommended_interviewers %}
                                                 {% if rec.interviewer.id == interviewer.id %}
                                                     style="border: 2px solid #ffc107; border-radius: 8px; padding: 10px; background-color: #fff3cd;"
                                                 {% endif %}
                                             {% endfor %}
                                         {% endif %}>
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="interviewer_{{ interviewer.id }}" 
                                               name="interviewer_ids[]" 
                                               value="{{ interviewer.id }}">
                                        <label class="form-check-label" for="interviewer_{{ interviewer.id }}">
                                            {{ interviewer.first_name }} {{ interviewer.last_name }}
                                            {% if recommended_interviewers %}
                                                {% for rec in recommended_interviewers %}
                                                    {% if rec.interviewer.id == interviewer.id %}
                                                        <span class="badge bg-warning text-dark ms-1">
                                                            <i class="fas fa-star"></i> Recommended
                                                        </span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            <br><small class="text-muted">{{ interviewer.email }}</small>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if not interviewers %}
                                <p class="text-muted">No interviewers available. Please add interviewers first.</p>
                                <a href="{{ url_for('manage_interviewers') }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-plus"></i> Add Interviewers
                                </a>
                            {% endif %}
                        </div>

                        <!-- 24/7 Scheduling Info -->
                        <div class="alert alert-success mb-4">
                            <h6><i class="fas fa-check-circle me-2"></i>24/7 Interview Scheduling Active</h6>
                            <ul class="mb-0">
                                <li>Schedule interviews at any time - day or night</li>
                                <li>Weekend and holiday scheduling available</li>
                                <li>No business hour restrictions</li>
                                <li>Candidates will receive notifications regardless of time</li>
                                <li>Automatic timezone handling for global candidates</li>
                                {% if recommended_interviewers %}
                                <li class="text-warning"><strong>Employer has recommended specific interviewers for this position</strong></li>
                                {% endif %}
                            </ul>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('manager_dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="scheduleBtn">
                                <i class="fas fa-calendar-check me-1"></i>Schedule Interview (24/7)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Set minimum datetime to current time
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const currentDateTime = now.getFullYear() + '-' + 
        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
        String(now.getDate()).padStart(2, '0') + 'T' + 
        String(now.getHours()).padStart(2, '0') + ':' + 
        String(now.getMinutes()).padStart(2, '0');
    
    document.getElementById('scheduled_time').value = currentDateTime;
    document.getElementById('scheduled_time').min = currentDateTime;
});

// Function to select a specific recommended interviewer
function selectRecommendedInterviewer(interviewerId) {
    // Clear all selections first
    const allCheckboxes = document.querySelectorAll('input[name="interviewer_ids[]"]');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Select the specific interviewer
    const targetCheckbox = document.getElementById('interviewer_' + interviewerId);
    if (targetCheckbox) {
        targetCheckbox.checked = true;
        // Scroll to the selected interviewer
        targetCheckbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Highlight the selection temporarily
        const parentDiv = targetCheckbox.closest('.col-md-6');
        if (parentDiv) {
            parentDiv.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                parentDiv.style.backgroundColor = '';
            }, 2000);
        }
    }
}

// Function to select all recommended interviewers
function selectAllRecommended() {
    {% if recommended_interviewers %}
    const recommendedIds = [{% for rec in recommended_interviewers %}{{ rec.interviewer.id }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    // Clear all selections first
    const allCheckboxes = document.querySelectorAll('input[name="interviewer_ids[]"]');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Select only recommended interviewers
    recommendedIds.forEach(id => {
        const checkbox = document.getElementById('interviewer_' + id);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Show confirmation message
    const selectedCount = recommendedIds.length;
    const message = selectedCount === 1 ? 
        'Selected 1 recommended interviewer' : 
        `Selected ${selectedCount} recommended interviewers`;
    
    // Create temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
    alertDiv.innerHTML = `
        <i class="fas fa-check me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const interviewersSection = document.querySelector('label').parentNode;
    interviewersSection.insertBefore(alertDiv, document.getElementById('interviewersList'));
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
    {% endif %}
}

// Form validation
document.getElementById('scheduleBtn').addEventListener('click', function(e) {
    const selectedInterviewers = document.querySelectorAll('input[name="interviewer_ids[]"]:checked');
    
    if (selectedInterviewers.length === 0) {
        e.preventDefault();
        alert('Please select at least one interviewer.');
        return false;
    }
    
    const scheduledTime = document.getElementById('scheduled_time').value;
    if (!scheduledTime) {
        e.preventDefault();
        alert('Please select a date and time for the interview.');
        return false;
    }
    
    // Show confirmation for recommended vs non-recommended selection
    {% if recommended_interviewers %}
    const recommendedIds = [{% for rec in recommended_interviewers %}{{ rec.interviewer.id }}{% if not loop.last %},{% endif %}{% endfor %}];
    const selectedIds = Array.from(selectedInterviewers).map(cb => parseInt(cb.value));
    const hasRecommended = selectedIds.some(id => recommendedIds.includes(id));
    const hasNonRecommended = selectedIds.some(id => !recommendedIds.includes(id));
    
    if (hasNonRecommended && !hasRecommended) {
        const confirmMsg = 'You have not selected any of the employer-recommended interviewers. Are you sure you want to proceed?';
        if (!confirm(confirmMsg)) {
            e.preventDefault();
            return false;
        }
    }
    {% endif %}
    
    return true;
});
</script>
{% endblock %}
