{% extends "base.html" %}

{% block title %}Manage Jobs - JobMatch Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="p-3">
                <h5 class="text-center mb-4">
                    <i class="fas fa-building me-2"></i>{{ company.company_name[:15] }}{% if company.company_name|length > 15 %}...{% endif %}
                </h5>
                <nav class="nav flex-column">
                    <a class="nav-link" href="{{ url_for('employer_dashboard') }}">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    <a class="nav-link active" href="{{ url_for('employer_jobs') }}">
                        <i class="fas fa-briefcase me-2"></i>My Jobs
                    </a>
                    <a class="nav-link" href="{{ url_for('create_job') }}">
                        <i class="fas fa-plus me-2"></i>Post New Job
                    </a>
                    <a class="nav-link" href="{{ url_for('employer_applications') }}">
                        <i class="fas fa-file-alt me-2"></i>Applications
                    </a>
                    <a class="nav-link" href="{{ url_for('messages') }}">
                        <i class="fas fa-envelope me-2"></i>Messages
                    </a>
                </nav>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 main-content">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2><i class="fas fa-briefcase me-2"></i>Manage Job Postings</h2>
                            <p class="text-muted">Create, edit, and manage your job listings</p>
                        </div>
                        <a href="{{ url_for('create_job') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Post New Job
                        </a>
                    </div>
                </div>
            </div>

            <!-- Job Statistics -->
            <div class="row mb-4">
                {% set total_jobs = job_postings|length %}
                {% set active_jobs = job_postings|selectattr('0.is_active', 'equalto', true)|list|length %}
                {% set total_applications = job_postings|sum(attribute='1') %}
                
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3>{{ total_jobs }}</h3>
                                <p class="mb-0">Total Jobs</p>
                            </div>
                            <i class="fas fa-briefcase fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #27ae60, #58d68d);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3>{{ active_jobs }}</h3>
                                <p class="mb-0">Active Jobs</p>
                            </div>
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #3498db, #85c1e9);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3>{{ total_applications }}</h3>
                                <p class="mb-0">Total Applications</p>
                            </div>
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #f39c12, #f7dc6f);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3>{{ (total_applications / total_jobs)|round(1) if total_jobs > 0 else 0 }}</h3>
                                <p class="mb-0">Avg Applications</p>
                            </div>
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Listings -->
            <div class="row">
                <div class="col-12">
                    {% if job_postings %}
                        {% for job, application_count in job_postings %}
                        <div class="card mb-4 job-card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h5 class="mb-1">
                                                    {{ job.title }}
                                                    {% if not job.is_active %}
                                                    <span class="badge bg-secondary ms-2">Inactive</span>
                                                    {% endif %}
                                                </h5>
                                                <div class="job-meta mb-2">
                                                    <span class="text-muted me-3">
                                                        <i class="fas fa-map-marker-alt me-1"></i>{{ job.location or 'Remote' }}
                                                    </span>
                                                    <span class="text-muted me-3">
                                                        <i class="fas fa-clock me-1"></i>{{ job.job_type }}
                                                    </span>
                                                    <span class="text-muted">
                                                        <i class="fas fa-user-tie me-1"></i>{{ job.experience_required }}+ years
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-primary fs-6 mb-2">{{ application_count }} Applications</span>
                                                {% if job.application_deadline %}
                                                <br><small class="text-warning">
                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                    Deadline: {{ job.application_deadline.strftime('%b %d, %Y') }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        {% if job.salary_min and job.salary_max %}
                                        <div class="mb-2">
                                            <span class="text-success fw-bold">
                                                <i class="fas fa-dollar-sign me-1"></i>
                                                ${{ "{:,.0f}".format(job.salary_min) }} - ${{ "{:,.0f}".format(job.salary_max) }}
                                            </span>
                                        </div>
                                        {% endif %}
                                        
                                        <p class="text-muted mb-3">
                                            {{ job.description[:150] }}{% if job.description|length > 150 %}...{% endif %}
                                        </p>
                                        
                                        <div class="d-flex align-items-center">
                                            <small class="text-muted me-3">
                                                <i class="fas fa-calendar-plus me-1"></i>
                                                Posted {{ job.created_at.strftime('%b %d, %Y') }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-eye me-1"></i>
                                                Last updated {{ job.updated_at.strftime('%b %d, %Y') }}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="d-flex flex-column h-100 justify-content-between">
                                            <!-- Job Status Toggle -->
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="job_status_{{ job.id }}" 
                                                           {{ 'checked' if job.is_active }}
                                                           onchange="toggleJobStatus({{ job.id }})">
                                                    <label class="form-check-label" for="job_status_{{ job.id }}">
                                                        <strong>{{ 'Active' if job.is_active else 'Inactive' }}</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    {{ 'Visible to candidates' if job.is_active else 'Hidden from candidates' }}
                                                </small>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="d-grid gap-2">
                                                <a href="{{ url_for('job_details', job_id=job.id) }}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye me-1"></i>View Public Page
                                                </a>
                                                
                                                {% if application_count > 0 %}
                                                <a href="{{ url_for('employer_applications', job_id=job.id) }}" 
                                                   class="btn btn-primary btn-sm">
                                                    <i class="fas fa-users me-1"></i>View Applications ({{ application_count }})
                                                </a>
                                                {% endif %}
                                                
                                                <div class="btn-group">
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            onclick="editJob({{ job.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            onclick="duplicateJob({{ job.id }})">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            onclick="shareJob({{ job.id }})">
                                                        <i class="fas fa-share"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" 
                                                            onclick="deleteJob({{ job.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-briefcase fa-4x text-muted mb-4"></i>
                                <h4 class="text-muted">No Job Postings Yet</h4>
                                <p class="text-muted mb-4">
                                    Create your first job posting to start attracting top talent to your company.
                                </p>
                                <a href="{{ url_for('create_job') }}" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus me-2"></i>Post Your First Job
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.job-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border-left: 4px solid transparent;
}

.job-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.job-card .card-body {
    border-left: 4px solid #28a745;
}

.job-card:has(.form-check-input:not(:checked)) .card-body {
    border-left-color: #6c757d;
}

.job-meta span {
    font-size: 0.9rem;
}

.form-check-input:checked {
    background-color: var(--success-color);
    border-color: var(--success-color);
}
</style>

<script>
function toggleJobStatus(jobId) {
    if (confirm('Are you sure you want to change the status of this job?')) {
        // Implement AJAX call to toggle job status
        fetch(`/employer/job/${jobId}/toggle_status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating job status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating job status');
        });
    }
}

function editJob(jobId) {
    window.location.href = `/employer/job/${jobId}/edit`;
}

function duplicateJob(jobId) {
    if (confirm('Create a copy of this job posting?')) {
        fetch(`/employer/job/${jobId}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Job duplicated successfully!');
                location.reload();
            } else {
                alert('Error duplicating job');
            }
        });
    }
}

function shareJob(jobId) {
    const jobUrl = `${window.location.origin}/job/${jobId}`;
    if (navigator.share) {
        navigator.share({
            title: 'Job Opportunity',
            text: 'Check out this job opportunity!',
            url: jobUrl
        });
    } else {
        navigator.clipboard.writeText(jobUrl).then(() => {
            alert('Job link copied to clipboard!');
        });
    }
}

function deleteJob(jobId) {
    if (confirm('Are you sure you want to delete this job posting? This action cannot be undone.')) {
        fetch(`/employer/job/${jobId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Job deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting job');
            }
        });
    }
}
</script>
{% endblock %}
