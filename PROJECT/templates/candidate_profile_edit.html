{% extends "base.html" %}
{% block title %}Edit Profile - {{ user.first_name }} {{ user.last_name }}{% endblock %}
{% block content %}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-user-edit"></i> Edit Your Profile</h2>
                    <p class="text-muted mb-0">Keep your profile updated to get better job matches</p>
                </div>
                <div class="card-body">
                    <!-- Profile Completion Progress -->
                    <div class="mb-4">
                        <h6 class="text-muted">Profile Completion</h6>
                        {% set completion = 0 %}
                        {% if profile.experience_years %}{% set completion = completion + 15 %}{% endif %}
                        {% if profile.education_level %}{% set completion = completion + 15 %}{% endif %}
                        {% if profile.current_position %}{% set completion = completion + 15 %}{% endif %}
                        {% if profile.location %}{% set completion = completion + 15 %}{% endif %}
                        {% if profile.summary %}{% set completion = completion + 15 %}{% endif %}
                        {% if profile.cv_filename %}{% set completion = completion + 25 %}{% endif %}
                        
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: {{ completion }}%" 
                                 aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">
                                {{ completion }}%
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col"><small class="text-{{ 'success' if profile.experience_years else 'muted' }}">Experience</small></div>
                            <div class="col"><small class="text-{{ 'success' if profile.education_level else 'muted' }}">Education</small></div>
                            <div class="col"><small class="text-{{ 'success' if profile.current_position else 'muted' }}">Position</small></div>
                            <div class="col"><small class="text-{{ 'success' if profile.location else 'muted' }}">Location</small></div>
                            <div class="col"><small class="text-{{ 'success' if profile.summary else 'muted' }}">Summary</small></div>
                            <div class="col"><small class="text-{{ 'success' if profile.cv_filename else 'muted' }}">CV</small></div>
                        </div>
                    </div>

                    <!-- IMPORTANT: Added enctype="multipart/form-data" for file upload -->
                    <form method="POST" action="{{ url_for('candidate_profile') }}" enctype="multipart/form-data">
                        
                        <!-- Personal Information Section -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="first_name" class="form-label"><strong>First Name *</strong></label>
                                <input type="text" class="form-control" id="first_name" name="first_name" 
                                       value="{{ user.first_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="last_name" class="form-label"><strong>Last Name *</strong></label>
                                <input type="text" class="form-control" id="last_name" name="last_name" 
                                       value="{{ user.last_name }}" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="phone" class="form-label"><strong>Phone Number</strong></label>
                                <input type="tel" class="form-control" id="phone" name="phone" 
                                       value="{{ user.phone or '' }}" placeholder="e.g., +1-234-567-8900">
                            </div>
                            <div class="col-md-6">
                                <label for="location" class="form-label"><strong>Location</strong></label>
                                <input type="text" class="form-control" id="location" name="location" 
                                       value="{{ profile.location or '' }}" placeholder="e.g., New York, NY">
                            </div>
                        </div>

                        <!-- Professional Information Section -->
                        <hr class="my-4">
                        <h5 class="mb-3"><i class="fas fa-briefcase"></i> Professional Information</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="current_position" class="form-label"><strong>Current Position</strong></label>
                                <input type="text" class="form-control" id="current_position" name="current_position" 
                                       value="{{ profile.current_position or '' }}" placeholder="e.g., Software Engineer">
                            </div>
                            <div class="col-md-6">
                                <label for="experience_years" class="form-label"><strong>Years of Experience</strong></label>
                                <input type="number" class="form-control" id="experience_years" name="experience_years" 
                                       value="{{ profile.experience_years or 0 }}" min="0" max="50">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="education_level" class="form-label"><strong>Education Level</strong></label>
                                <select class="form-control" id="education_level" name="education_level">
                                    <option value="">Select Education Level</option>
                                    <option value="High School" {{ 'selected' if profile.education_level == 'High School' }}>High School</option>
                                    <option value="Bachelor" {{ 'selected' if profile.education_level == 'Bachelor' }}>Bachelor's Degree</option>
                                    <option value="Master" {{ 'selected' if profile.education_level == 'Master' }}>Master's Degree</option>
                                    <option value="PhD" {{ 'selected' if profile.education_level == 'PhD' }}>PhD</option>
                                    <option value="Other" {{ 'selected' if profile.education_level == 'Other' }}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="salary_expectation" class="form-label"><strong>Salary Expectation (Annual)</strong></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="salary_expectation" name="salary_expectation" 
                                           value="{{ profile.salary_expectation or '' }}" placeholder="e.g., 75000" step="1000">
                                </div>
                            </div>
                        </div>

                        <!-- CV Upload Section - THIS IS THE CRITICAL FIX -->
                        <div class="mb-3">
                            <label for="cv_file" class="form-label"><strong>Upload CV/Resume</strong></label>
                            <input type="file" class="form-control" id="cv_file" name="cv_file" 
                                   accept=".pdf,.doc,.docx">
                            <div class="form-text">
                                Accepted formats: PDF, DOC, DOCX (Max 16MB)
                                {% if profile.cv_filename %}
                                    <br><span class="text-success"><i class="fas fa-file"></i> Current CV: {{ profile.cv_filename }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Professional Summary -->
                        <div class="mb-3">
                            <label for="summary" class="form-label"><strong>Professional Summary</strong></label>
                            <textarea class="form-control" id="summary" name="summary" rows="4" 
                                      placeholder="Briefly describe your professional experience, key skills, and career objectives...">{{ profile.summary or '' }}</textarea>
                            <div class="form-text">This helps employers understand your background and goals.</div>
                        </div>

                        <!-- Skills Section -->
                        <hr class="my-4">
                        <h5 class="mb-3"><i class="fas fa-tools"></i> Skills & Expertise</h5>
                        
                        {% if available_skills %}
                        <div class="mb-3">
                            <label class="form-label"><strong>Select Your Skills</strong></label>
                            <div class="row">
                                {% for skill in available_skills %}
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        {% set is_selected = skill.id in candidate_skills|map(attribute='0.skill_id')|list %}
                                        <input class="form-check-input" type="checkbox" 
                                               id="skill_{{ skill.id }}" name="skills[]" value="{{ skill.id }}"
                                               {{ 'checked' if is_selected }}
                                               onchange="toggleSkillDetails({{ skill.id }})">
                                        <label class="form-check-label" for="skill_{{ skill.id }}">
                                            {{ skill.skill_name }}
                                            <small class="text-muted">({{ skill.category or 'General' }})</small>
                                        </label>
                                    </div>
                                    
                                    <!-- Skill Details (shown when skill is selected) -->
                                    <div id="skill_details_{{ skill.id }}" class="ms-4 mt-1" 
                                         style="display: {{ 'block' if is_selected else 'none' }}">
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-control form-control-sm" 
                                                        name="proficiency_{{ skill.id }}">
                                                    {% set current_proficiency = '' %}
                                                    {% for cs, s in candidate_skills %}
                                                        {% if s.id == skill.id %}
                                                            {% set current_proficiency = cs.proficiency_level %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    <option value="Beginner" {{ 'selected' if current_proficiency == 'Beginner' }}>Beginner</option>
                                                    <option value="Intermediate" {{ 'selected' if current_proficiency == 'Intermediate' or not current_proficiency }}>Intermediate</option>
                                                    <option value="Advanced" {{ 'selected' if current_proficiency == 'Advanced' }}>Advanced</option>
                                                    <option value="Expert" {{ 'selected' if current_proficiency == 'Expert' }}>Expert</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                {% set current_years = 0 %}
                                                {% for cs, s in candidate_skills %}
                                                    {% if s.id == skill.id %}
                                                        {% set current_years = cs.years_experience %}
                                                    {% endif %}
                                                {% endfor %}
                                                <input type="number" class="form-control form-control-sm" 
                                                       name="years_{{ skill.id }}" placeholder="Years" 
                                                       value="{{ current_years }}" min="0" max="50">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('candidate_dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for dynamic skill details -->
<script>
function toggleSkillDetails(skillId) {
    const checkbox = document.getElementById('skill_' + skillId);
    const details = document.getElementById('skill_details_' + skillId);
    
    if (checkbox.checked) {
        details.style.display = 'block';
    } else {
        details.style.display = 'none';
        // Clear values when unchecked
        const proficiency = details.querySelector('select');
        const years = details.querySelector('input[type="number"]');
        if (proficiency) proficiency.value = 'Intermediate';
        if (years) years.value = '0';
    }
}

// Show skill details for already selected skills on page load
document.addEventListener('DOMContentLoaded', function() {
    {% for skill in available_skills %}
        {% if skill.id in candidate_skills|map(attribute='0.skill_id')|list %}
            document.getElementById('skill_details_{{ skill.id }}').style.display = 'block';
        {% endif %}
    {% endfor %}
});
</script>

{% endblock %}
